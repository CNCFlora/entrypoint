<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
</head>
<body>
    <div class="container-fluid">
        <header class="col-md-12">
            <h1>CNCFlora - Sistemas</h1>
        </header>
        <ul id='systems'>
        </ul>
    </div>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        $(function(){
            var url = "http://"+location.host+"/etcd/v2/keys/?recursive=true";
            $.getJSON(url,function(data){
                var links=[]
                for(var i in data.node.nodes) {
                    var node = data.node.nodes[i];
                    if(node.dir) {
                        var n = {}
                        for(var i in node.nodes) {
                            var info = node.nodes[i];
                            if(info.key == node.key+'/name') {
                                n.name = info.value;
                            }
                            if(info.key == node.key+'/networksettings') {
                                n.ports=[];
                                for(var c in info.nodes) {
                                    if(info.nodes[c].key == node.key+'/networksettings/ports') {
                                        for(var o in info.nodes[c].nodes) {
                                            var port = info.nodes[c].nodes[o].key.match(/[0-9]+$/);
                                            if(port) {
                                                var port0 = info.nodes[c].nodes[o].key.match(/[0-9]+$/)[0];
                                                var port1 = info.nodes[c].nodes[o].nodes[0].nodes[1].value;
                                                n.ports.push([port0,port1]);
                                            }
                                        }
                                    }
                                }
                            }
                            if(info.key == node.key+"/url") {
                                n.url = info.value;
                            }
                            if(info.key == node.key+"/host") {
                                n.host = info.value;
                            }
                        }
                        links.push(n);
                    }
                }


                for(var i in links) {
                    var html = '<li><strong>'+links[i].name+'</strong><ul>';
                    html += "<li><a href='"+links[i].url+"'>"+links[i].url+"</a></li>";
                    for(var p in links[i].ports) {
                        html += "<li><a href='http://"+links[i].host+":"+links[i].ports[p][1]+"'>"
                                +"http://"+links[i].host+":"+links[i].ports[p][0]+"</a></li>";
                    }
                    html += "</ul></li>";
                    console.log(html)
                    $("ul#systems").append(html);
                }
            });
        });
    </script>
</body>
</html>
